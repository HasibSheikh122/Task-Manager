{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard - Task Manager{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<div class="container">
<div class="row">
    <!-- Statistics Cards -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Tasks</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tasks fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Completed Tasks</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ completed_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Pending Tasks</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Overdue Tasks</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ overdue_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Task Status Chart -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Task Status Overview</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                        aria-labelledby="dropdownMenuLink">
                        <a class="dropdown-item" href="{% url 'task_list' %}?status=completed">View Completed</a>
                        <a class="dropdown-item" href="{% url 'task_list' %}?status=pending">View Pending</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{% url 'task_create' %}">Create New Task</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="taskStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Priority Chart -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Task Priority</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4">
                    <canvas id="taskPriorityChart"></canvas>
                </div>
                <div class="mt-4 text-center small">
                    <span class="mr-2">
                        <i class="fas fa-circle text-danger"></i> High
                    </span>
                    <span class="mr-2">
                        <i class="fas fa-circle text-warning"></i> Medium
                    </span>
                    <span class="mr-2">
                        <i class="fas fa-circle text-success"></i> Low
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Tasks -->
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <div>
                    <h6 class="m-0 font-weight-bold text-primary">Recent Tasks</h6>
                    {% if recent_tasks %}
                    <small class="text-muted">
                        Showing {{ recent_tasks.start_index }} - {{ recent_tasks.end_index }} of {{ recent_tasks.paginator.count }}
                    </small>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center">
                    <!-- Pagination Controls for Recent Tasks -->
                    {% if recent_tasks %}
                    <form method="get" class="d-flex align-items-center me-3">
                        <label for="recent_per_page" class="me-2 mb-0 small">Show:</label>
                        <select name="recent_per_page" id="recent_per_page" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                            <option value="5" {% if recent_per_page == 5 %}selected{% endif %}>5</option>
                            <option value="10" {% if recent_per_page == 10 %}selected{% endif %}>10</option>
                            <option value="15" {% if recent_per_page == 15 %}selected{% endif %}>15</option>
                            <option value="20" {% if recent_per_page == 20 %}selected{% endif %}>20</option>
                        </select>
                    </form>
                    {% endif %}
                    <a href="{% url 'task_list' %}" class="btn btn-sm btn-primary">
                        View All <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_tasks %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in recent_tasks %}
                            <tr>
                                <td>
                                    <strong>{{ task.title }}</strong>
                                    <br>
                                    <small class="text-muted">{{ task.description|truncatechars:50 }}</small>
                                </td>
                                <td>
                                    {% if task.priority == 'high' %}
                                    <span class="badge bg-danger">High</span>
                                    {% elif task.priority == 'medium' %}
                                    <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                    <span class="badge bg-success">Low</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                    {% elif task.status == 'in_progress' %}
                                    <span class="badge bg-info">In Progress</span>
                                    {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.due_date %}
                                    {{ task.due_date|date:"M d, Y" }}
                                    {% if task.is_overdue %}
                                    <br><small class="text-danger">Overdue</small>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">No due date</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'task_detail' task.pk %}" class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'task_update' task.pk %}" class="btn btn-outline-secondary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if task.status != 'completed' %}
                                        <a href="{% url 'task_complete' task.pk %}" class="btn btn-outline-success">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                                    <p>No tasks found. <a href="{% url 'task_create' %}">Create your first task</a></p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <!-- Pagination for Recent Tasks -->
                    {% if recent_tasks.has_other_pages %}
                    <nav aria-label="Recent tasks pagination">
                        <ul class="pagination justify-content-center">
                            {% if recent_tasks.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?recent_page={{ recent_tasks.previous_page_number }}{% if recent_per_page %}&recent_per_page={{ recent_per_page }}{% endif %}">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fas fa-chevron-left"></i> Previous</span>
                            </li>
                            {% endif %}
                            
                            {% for i in recent_tasks.paginator.page_range %}
                                {% if recent_tasks.number == i %}
                                <li class="page-item active">
                                    <span class="page-link">{{ i }}</span>
                                </li>
                                {% elif i > recent_tasks.number|add:'-3' and i < recent_tasks.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?recent_page={{ i }}{% if recent_per_page %}&recent_per_page={{ recent_per_page }}{% endif %}">{{ i }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if recent_tasks.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?recent_page={{ recent_tasks.next_page_number }}{% if recent_per_page %}&recent_per_page={{ recent_per_page }}{% endif %}">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next <i class="fas fa-chevron-right"></i></span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No tasks found</h5>
                    <p class="text-muted">
                        <a href="{% url 'task_create' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-plus"></i> Create Your First Task
                        </a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'task_create' %}" class="btn btn-primary btn-block">
                            <i class="fas fa-plus"></i> New Task
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'task_list' %}?status=pending" class="btn btn-warning btn-block">
                            <i class="fas fa-clock"></i> Pending Tasks
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'task_list' %}?status=completed" class="btn btn-success btn-block">
                            <i class="fas fa-check"></i> Completed Tasks
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'manage_categories' %}" class="btn btn-info btn-block">
                            <i class="fas fa-folder"></i> Manage Categories
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Task Status Chart
const taskStatusCtx = document.getElementById('taskStatusChart').getContext('2d');
const taskStatusChart = new Chart(taskStatusCtx, {
    type: 'bar',
    data: {
        labels: ['Pending', 'In Progress', 'Completed', 'Overdue'],
        datasets: [{
            label: 'Number of Tasks',
            data: [
                {{ pending_tasks }},
                {{ in_progress_tasks }},
                {{ completed_tasks }},
                {{ overdue_tasks }}
            ],
            backgroundColor: [
                'rgba(151, 43, 1, 0.7)',
                'rgba(3, 148, 148, 0.7)',
                'rgba(4, 107, 0, 0.7)',
                'rgba(191, 3, 248, 0.7)'
            ],
            borderColor: [
                'rgba(7, 23, 255, 1)',
                'rgba(54, 185, 204, 1)',
                'rgba(28, 200, 138, 1)',
                'rgba(231, 74, 59, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Task Priority Chart
const taskPriorityCtx = document.getElementById('taskPriorityChart').getContext('2d');
const taskPriorityChart = new Chart(taskPriorityCtx, {
    type: 'doughnut',
    data: {
        labels: ['High', 'Medium', 'Low'],
        datasets: [{
            data: [
                {{ high_priority_tasks|default:0 }},
                {{ medium_priority_tasks|default:0 }},
                {{ low_priority_tasks|default:0 }}
            ],
            backgroundColor: [
                'rgba(253, 22, 1, 0.7)',
                'rgba(51, 9, 236, 0.7)',
                'rgba(28, 200, 138, 0.7)'
            ],
            borderColor: [
                'rgba(250, 25, 4, 1)',
                'rgba(28, 6, 228, 1)',
                'rgba(0, 119, 75, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        },
        cutout: '70%'
    }
});

// Auto-refresh dashboard every 30 seconds
setTimeout(function() {
    window.location.reload();
}, 30000);

// Function to handle recent tasks pagination
document.addEventListener('DOMContentLoaded', function() {
    const recentPerPage = document.getElementById('recent_per_page');
    if (recentPerPage) {
        recentPerPage.addEventListener('change', function() {
            const form = this.closest('form');
            const currentUrl = new URL(window.location.href);
            const params = new URLSearchParams(currentUrl.search);
            
            // Update or add recent_per_page parameter
            params.set('recent_per_page', this.value);
            
            // Keep other parameters
            if (params.has('recent_page')) {
                params.set('recent_page', '1'); // Reset to page 1 when changing per_page
            }
            
            // Update URL and submit form
            form.action = currentUrl.pathname + '?' + params.toString();
            form.submit();
        });
    }
});
</script>

<style>
    #recent_per_page {
        width: 80px;
    }
    .page-link {
        min-width: 40px;
        text-align: center;
    }
</style>
{% endblock %}