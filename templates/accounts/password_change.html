{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Change Password - Task Manager{% endblock %}
{% block header %}Change Password{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'profile' %}">Profile</a></li>
<li class="breadcrumb-item active">Change Password</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-key"></i> Change Your Password
                </h6>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Display form errors -->
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> Please fix the following errors:</h6>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- Current Password -->
                    <div class="mb-3">
                        <label for="id_old_password" class="form-label">
                            <i class="fas fa-lock"></i> Current Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="old_password" 
                                   id="id_old_password" 
                                   class="form-control {% if form.old_password.errors %}is-invalid{% endif %}" 
                                   placeholder="Enter your current password"
                                   required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleOldPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.old_password.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="id_new_password1" class="form-label">
                            <i class="fas fa-key"></i> New Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="new_password1" 
                                   id="id_new_password1" 
                                   class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}" 
                                   placeholder="Enter new password"
                                   required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength mt-2" id="passwordStrength"></div>
                        {% if form.new_password1.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.new_password1.errors.0 }}
                        </div>
                        {% else %}
                        <small class="form-text text-muted">
                            <ul class="mb-0 ps-3">
                                <li>Your password can't be too similar to your other personal information.</li>
                                <li>Your password must contain at least 8 characters.</li>
                                <li>Your password can't be a commonly used password.</li>
                                <li>Your password can't be entirely numeric.</li>
                            </ul>
                        </small>
                        {% endif %}
                    </div>
                    
                    <!-- Confirm New Password -->
                    <div class="mb-4">
                        <label for="id_new_password2" class="form-label">
                            <i class="fas fa-key"></i> Confirm New Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="new_password2" 
                                   id="id_new_password2" 
                                   class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}" 
                                   placeholder="Confirm new password"
                                   required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword2">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                        <div class="invalid-feedback">
                            {{ form.new_password2.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'profile' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Password Tips -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-lightbulb"></i> Password Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Use at least 12 characters</li>
                    <li>Include numbers, symbols, capital and lowercase letters</li>
                    <li>Avoid using the same password for multiple sites</li>
                    <li>Don't use common words or personal information</li>
                    <li>Consider using a password manager</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle password visibility
    function setupPasswordToggle(inputId, buttonId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(buttonId);
        
        if (passwordInput && toggleButton) {
            toggleButton.addEventListener('click', function() {
                const icon = this.querySelector('i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }
    }
    
    setupPasswordToggle('id_old_password', 'toggleOldPassword');
    setupPasswordToggle('id_new_password1', 'toggleNewPassword1');
    setupPasswordToggle('id_new_password2', 'toggleNewPassword2');
    
    // Password strength checker
    const newPasswordInput = document.getElementById('id_new_password1');
    const passwordStrengthBar = document.getElementById('passwordStrength');
    
    if (newPasswordInput && passwordStrengthBar) {
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            
            // Reset
            passwordStrengthBar.innerHTML = '';
            passwordStrengthBar.className = 'password-strength';
            
            if (password.length === 0) return;
            
            let strength = 0;
            let tips = [];
            
            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            
            // Complexity checks
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            // Update strength bar
            const strengthColors = ['bg-danger', 'bg-warning', 'bg-info', 'bg-success'];
            const strengthText = ['Very Weak', 'Weak', 'Good', 'Strong'];
            
            const bar = document.createElement('div');
            bar.className = `progress-bar ${strengthColors[Math.min(strength, 3)]}`;
            bar.style.width = `${Math.min(strength, 4) * 25}%`;
            bar.setAttribute('role', 'progressbar');
            bar.setAttribute('aria-valuenow', strength * 25);
            bar.setAttribute('aria-valuemin', '0');
            bar.setAttribute('aria-valuemax', '100');
            
            const progress = document.createElement('div');
            progress.className = 'progress';
            progress.style.height = '8px';
            progress.appendChild(bar);
            
            const text = document.createElement('div');
            text.className = 'small mt-1';
            text.textContent = `Strength: ${strengthText[Math.min(strength, 3)]}`;
            
            passwordStrengthBar.appendChild(progress);
            passwordStrengthBar.appendChild(text);
        });
    }
    
    // Password confirmation check
    const password1 = document.getElementById('id_new_password1');
    const password2 = document.getElementById('id_new_password2');
    
    function checkPasswordMatch() {
        if (password1 && password2 && password1.value && password2.value) {
            if (password1.value !== password2.value) {
                password2.classList.add('is-invalid');
                const feedback = password2.parentNode.querySelector('.invalid-feedback') || 
                                document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.innerHTML = '<i class="fas fa-exclamation-circle"></i> Passwords do not match';
                if (!password2.parentNode.querySelector('.invalid-feedback')) {
                    password2.parentNode.appendChild(feedback);
                }
            } else {
                password2.classList.remove('is-invalid');
                const feedback = password2.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            }
        }
    }
    
    if (password1 && password2) {
        password1.addEventListener('input', checkPasswordMatch);
        password2.addEventListener('input', checkPasswordMatch);
    }
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        let isValid = true;
        
        // Check if passwords match
        if (password1 && password2 && password1.value !== password2.value) {
            isValid = false;
            password2.classList.add('is-invalid');
        }
        
        // Check password strength
        if (password1 && password1.value.length < 8) {
            isValid = false;
            password1.classList.add('is-invalid');
        }
        
        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                Please fix the errors in the form.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            form.prepend(alertDiv);
        }
    });
});
</script>

<style>
.password-strength {
    margin-bottom: 10px;
}

.progress {
    border-radius: 5px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease;
}

.input-group .btn-outline-secondary {
    border-color: #ced4da;
}

.input-group .btn-outline-secondary:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}
</style>
{% endblock %}